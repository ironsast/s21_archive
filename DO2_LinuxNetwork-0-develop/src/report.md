# Сети в Linux

<br>

## Part 1. Инструмент **ipcalc**

<br>

**== Задание ==**
<br>
-1) Поднять виртуальную машину (Далее -- ws1)

-2) Сети и маски
<br> Определить и записать в отчёт:
<br> -2.1) Адрес сети *192.167.38.54/13*
<br>    - 2.2) Перевод маски *255.255.255.0* в префиксную и двоичную запись, */15* в обычную и двоичную, *11111111.11111111.11111111.11110000* в обычную и префиксную
<br>    - 2.3) Минимальный и максимальный хост в сети *12.167.38.4* при масках: */8*, *11111111.11111111.00000000.00000000*, *255.255.254.0* и */4*

- 3) localhost
<br>    Определить и записать в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: *194.34.23.100*, *127.0.0.2*, *127.1.0.1*, *128.0.0.1*

- 4) Диапазоны и сегменты сетей
<br>    Определить и записать в отчёт:
<br>    4.1) какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: *10.0.0.45*, *134.43.0.2*, *192.168.4.2*, *172.20.250.4*, *172.0.2.1*, *192.172.0.1*, *172.68.0.2*, *172.16.255.255*, *10.10.10.10*, *192.169.168.1*
<br>    4.2) какие из перечисленных IP адресов шлюза возможны у сети *10.10.0.0/18*: *10.0.0.1*, *10.10.0.2*, *10.10.10.10*, *10.10.100.1*, *10.10.1.255*

<br>

**== Выполнение ==**
<br>

- 1: Машина создана

<br>*Созданная машина*<br>

![Созданная машина](foto/1.0.png)
<br>

- 2: Сети и маски 
<br>* установка ipcalc

![Установка ipcalc](foto/1.1.png))
    - 2.1) Адрес сети *192.167.38.54/13* 
<br>*Результат работы команды ipcalc по этим данным*<br>

![Результат работы команды ipcalc по этим данным](foto/1.3.png)
<br>

- 2.2:
<br> Перевод маски 255.255.255.0

<br>*Отображение в консоли*<br>

![Отображение в консоли](foto/1.4.png)
<br> По результатам вывода можно сказать, что:
<br>    -Прификсная запись - 24
<br>    -Двоичная запись - 11111111.11111111.11111111.00000000
<br>
<br>    Перевод прификсной записи /15

<br>*Отображение в консоли*<br>

![Отображение в консоли](foto/1.5.png)
<br>    По результату вывода можно сказать что:
<br>        - Обычная запись 255.254.0.0
<br>        - Двоичная запись 11111111.11111110.00000000.00000000
<br>
<br>    Перевод бинарной записи 11111111.11111111.11111111.11110000:
<br>    Так как мы не можем на прямую обратиться к бинарному представлению через *ipcalc*, почитаем в ручную
<br>        - Прификс будет равен /28 (Количество активных едениц подряд)
<br>        - Маска будет равна 255.255.255.240 (Что соответствует прификсу /28)
<br> 

- 2.3: Минимальный и максимальный хост в сети *12.167.38.4* при масках:
<br>        
    

<br>*Min, max host /8*<br>

![Min, max host /8](foto/1.6.png)



<br>*Min, max, host 11111111.11111111.00000000.00000000*<br> 

![Min, max, host 11111111.11111111.00000000.00000000](foto/1.7.png)


<br>*Min, max host 255.255.254.0*<br>

![Min, max host 255.255.254.0](foto/1.8.png)
    

<br>*Min,max host /4*<br>

![Min,max host /4](foto/1.9.png)
<br>

- 3 localhost:
<br>    Определить, можно ли обратиться к приложению, работающему на localhost, со следующими IP: *194.34.23.100*, *127.0.0.2*, *127.1.0.1*, *128.0.0.1*:
<br>    Определим min - max localhost:

<br>*Min, max localhost*<br>

![Min, max localhost](foto/1.10.png)

<br>    Зная min - max, можно сказать что IP: 127.0.0.2, 127.1.0.1; подходят для поставленой выше задачи
<br>

- 4: Диапазоны и сегменты сетей:
<br>    - 4.1 Какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: 
Диапазоны частных  ip-адресов: 
* 10.0.0.0 - 10.255.255.255 
* 172.16.0.0 - 172.31.255.255 
* 192.168.0.0 - 192.168.255.255
<br>    *10.0.0.45* - частный, *134.43.0.2* - публичный, *192.168.4.2* - частный, *172.20.250.4* - частный, *172.0.2.1* - публичный, *192.172.0.1* - публичный, *172.68.0.2* - публичный, *172.16.255.255* - частный, *10.10.10.10* - частный, *192.169.168.1* - публичный;
<br>    - 4.2 какие из перечисленных IP адресов шлюза возможны у сети *10.10.0.0/18*:
<br>    Узнаем min - max для этой сети

<br>*min, max 10.10.0.0/18*<br>

![min, max 10.10.0.0/18](foto/1.11.png)

<br>    На основе этого можно сказать что не подходят только: 10.10.100.1 и 10.0.0.1
<br>

## Part 2. Статическая маршрутизация между двумя машинами

**== Задание ==**

<br>
<br> - С помощью команды `ip a` посмотреть существующие сетевые интерфейсы
<br> - В отчёт поместить скрин с вызовом и выводом использованной команды.
<br> - Описать сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски: ws1 - *192.168.100.10*, маска */16*, ws2 - *172.24.116.8*, маска */12*
<br> - В отчёт поместить скрины с содержанием изменённого файла *etc/netplan/00-installer-config.yaml* для каждой машины.
<br> - Выполнить команду `netplan apply` для перезапуска сервиса сети
<br> - В отчёт поместить скрин с вызовом и выводом использованной команды.

<br> 2.1. Добавление статического маршрута вручную
<br> - Добавить статический маршрут от одной машины до другой и обратно при помощи команды вида `ip r add`
<br> - Пропинговать соединение между машинами
<br> - В отчёт поместить скрин с вызовом и выводом использованных команд.

<br> 2.2. Добавление статического маршрута с сохранением
<br> - Перезапустить машины
<br> - Добавить статический маршрут от одной машины до другой с помощью файла *etc/netplan/00-installer-config.yaml*
<br> - В отчёт поместить скрин с содержанием изменённого файла *etc/netplan/00-installer-config.yaml*.
<br> - Пропинговать соединение между машинами
<br> - В отчёт поместить скрин с вызовом и выводом использованной команды.
<br>

**== Выполнение ==**
<br> 

- 1: результат работы команды *ip a*, на обоих машинах

<br>*Машина ws1*<br>

![Машина ws1](foto/2.0.png)

<br>*Машина ws2*<br>

![Машина ws2](foto/2.1.png)

<br>

- 2: Описать сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски: ws1 - 192.168.100.10, маска /16, ws2 - 172.24.116.8, маска /12

<br> - Редактируем соответствующие файлы в netplan на каждой машине и смотрим результат, и пременяем sudo netplan apply

<br>*Проверка результатов ws1*<br>

![Проверка результатов ws1](foto/2.2.png)

<br>*Проверка результатов ws2*<br>

![Проверка результатов ws2](foto/2.3.png)

<br>

- 3: Добавление статического маршрута вручную

<br> - Используем команду *sudo ip r add [нужный id] dev enp0s3* на каждой машние и пингуем их

<br>*Результат установки статического соединения*<br>

![Результат установки статического соединения](foto/2.4.png)

- 4 Добавление статического маршрута с сохранением

<br> - Перезапускаем машины с помощью команды *shutdown -r now*

<br>*Результат*<br>

![Результат](foto/2.5.png)

<br> - Редактируем netplan и смотрим результат 

<br>*Изменёный netplan*<br>

![Изменёный netplan](foto/2.6.png)

<br> - Пингуем обе машины

<br>*Результат пинга*<br>

![Результат пинга](foto/2.7.png)

<br>

## Part 3. Утилита **iperf3**

**== Задание ==**

<br>

- 1: 8 Mbps = 1 MB/s, 100 MB/s = 819200 Kbps, 1 Gbps = 1024 Mbps

- 2 Утилита **iperf3**:

<br>

<br> - Как сервер будет использоваться машина ws1 - 192.168.100.10, а как клиент машину ws2 - 172.24.116.8

<br> - Используем команду *iperf3 -s* на машине которая будет сервером
<br> - После используем команду *iperf3 -c 192.168.100.10* на клиентской машине

<br>*Результат выполнения команд на обоих машинах*<br>

![Результат выполнения команд на обоих машинах](foto/3.0.png)

<br>

## Part 4. Сетевой экран

**== Задание ==**

*В данном задании используются виртуальные машины ws1 и ws2 из Части 2*

- 4.1. Утилита **iptables**
- Создать файл */etc/firewall.sh*, имитирующий фаерволл, на ws1 и ws2:
<br>
shell
#!/bin/sh

# Удаление всех правил в таблице "filter" (по-умолчанию).
iptables –F
iptables -X

<br>

- Нужно добавить в файл подряд следующие правила:
- 1) на ws1 применить стратегию когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5)
- 2) на ws2 применить стратегию когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5)
- 3) открыть на машинах доступ для порта 22 (ssh) и порта 80 (http)
- 4) запретить *echo reply* (машина не должна "пинговаться”, т.е. должна быть блокировка на OUTPUT)
- 5) разрешить *echo reply* (машина должна "пинговаться")
- В отчёт поместить скрины с содержанием файла */etc/firewall* для каждой машины.
- Запустить файлы на обеих машинах командами `chmod +x /etc/firewall.sh` и `/etc/firewall.sh`
- В отчёт поместить скрины с запуском обоих файлов.
- В отчёте описать разницу между стратегиями, применёнными в первом и втором файлах.

- 4.2. Утилита **nmap**
- Командой **ping** найти машину, которая не "пингуется", после чего утилитой **nmap** показать, что хост машины запущен
*Проверка: в выводе nmap должно быть сказано: `Host is up`*
- В отчёт поместить скрины с вызовом и выводом использованных команд **ping** и **nmap**.

- Сохранить дампы образов виртуальных машин

<br>

**== Выполнение ==**

<br>

1: Утилита **iptables**

<br>

- Создаём файлы *firewall.sh* на обоих машинах командой *sudo nano /etc/firewall.sh*

- Заполняем всем необходимы по заданию

<br>*Отредктированные фйлы на двух машинах*<br>

![Отредактированные файлы на двух машинах](foto/4.0.png)

- Смотрим результаты внесённых изменений

<br>*Лист iptables и работа ping*<br>

![Лист iptables и работа ping](foto/4.1.png)

- Машина ws1 не пингуется, не возвращая ответов, в отличии от ws2
- Из этого можно сделать вывод что команда которая стоит выше по листу *iptables* не перестает работать если ниже была противоречащая команда

<br>

2: Утилита **nmap**

<br>

<br>*Результат работы команды*<br>

![Результат работы команды](foto/4.2.png)

- Ответ *Host is up* был получен, значит машина работает

<br>

## Part 5. Статическая маршрутизация сети


#### 5.1. Настройка адресов машин
##### Настроить конфигурации машин в *etc/netplan/00-installer-config.yaml* согласно сети на рисунке.
* ws11, ws21 и ws22
![ws11, ws21 и ws22](foto/5.0.png)

* r1 и r2
![r1 и r2](foto/5.1.png)


##### Перезапустить сервис сети. Если ошибок нет, то командой `ip -4 a` проверить, что адрес машины задан верно. Также пропинговать ws22 с ws21. Аналогично пропинговать r1 с ws11.
* ws11
![ws11](foto/5.2.png)
* ws21
![ws21](foto/5.3.png)
* ws22
![ws22](foto/5.4.png)
* r1
![r1](foto/5.5.png)
* r2
![r2](foto/5.6.png)

#### 5.2. Включение переадресации IP-адресов.
##### Для включения переадресации IP, выполните команду на роутерах:
`sysctl -w net.ipv4.ip_forward=1`
* r1 и r2
![r1 и r2](foto/5.7.png)

##### Откройте файл */etc/sysctl.conf* и добавьте в него следующую строку:
`net.ipv4.ip_forward = 1`
* r1 и r2
![r1 и r2](foto/5.8.png)

#### 5.3. Установка маршрута по-умолчанию

##### Настроить маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавить `default` перед IP роутера в файле конфигураций
- В отчёт поместить скрин с содержанием файла *etc/netplan/00-installer-config.yaml*.
* ws11, ws21 и ws22
![ws11, ws21 и ws22](foto/5.9.png)

##### Вызвать `ip r` и показать, что добавился маршрут в таблицу маршрутизации
* ws11, ws21 и ws22
![ws11, ws21 и ws22](foto/5.10.png)

##### Пропинговать с ws11 роутер r2 и показать на r2, что пинг доходит. Для этого использовать команду:
`tcpdump -tn -i eth1`
![tcpdump -tn -i eth1](foto/5.11.png)
![tcpdump -tn -i eth1](foto/5.12.png)

#### 5.4. Добавление статических маршрутов
##### Добавить в роутеры r1 и r2 статические маршруты в файле конфигураций.
* r1 и r2
![r1 и r2](foto/5.4.1.png)


##### Вызвать `ip r` и показать таблицы с маршрутами на обоих роутерах. Пример таблицы на r1:
* r1 и r2
![r1 и r2](foto/5.4.2.png)

##### Запустить команды на ws11:
`ip r list 10.10.0.0/[маска сети]` и `ip r list 0.0.0.0/0`
![ip r](foto/5.4.3.png)
Для адреса 10.10.0.0/[порт сети] был выбран маршрут, отличный от 0.0.0.0/0, потому что маска /18 описывает маршрут к сети точнее, в отличие от маски /0

#### 5.5. Построение списка маршрутизаторов

##### Запустить на r1 команду дампа:
`tcpdump -tnv -i eth0`
![tcpdump -tnv -i eth0](foto/5.5.1.png)
##### При помощи утилиты **traceroute** построить список маршрутизаторов на пути от ws11 до ws21
![traceroute](foto/5.5.2.png)

Принцип работы traceroute

Для определения промежуточных маршрутизаторов traceroute отправляет серию пакетов данных целевому узлу, при этом каждый раз увеличивая на 1 значение поля TTL («время жизни»). Это поле обычно указывает максимальное количество маршрутизаторов, которое может быть пройдено пакетом. Первый пакет отправляется с TTL, равным 1, и поэтому первый же маршрутизатор возвращает обратно сообщение ICMP, указывающее на невозможность доставки данных. Traceroute фиксирует адрес маршрутизатора, а также время между отправкой пакета и получением ответа (эти сведения выводятся на монитор компьютера). Затем traceroute повторяет отправку пакета, но уже с TTL, равным 2, что позволяет первому маршрутизатору пропустить пакет дальше.

Процесс повторяется до тех пор, пока при определённом значении TTL пакет не достигнет целевого узла. При получении ответа от этого узла процесс трассировки считается завершённым.

#### 5.6. Использование протокола **ICMP** при маршрутизации
##### Запустить на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды:
`tcpdump -n -i eth0 icmp`
##### Пропинговать с ws11 несуществующий IP (например, *10.30.0.111*) с помощью команды:
`ping -c 1 10.30.0.111`

![ping](foto/5.6.1.png)
![tcpdump](foto/5.6.2.png)


## Part 6. Динамическая настройка IP с помощью **DHCP**


##### Для r2 настроить в файле */etc/dhcp/dhcpd.conf* конфигурацию службы **DHCP**:
##### 1) указать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети. 
![r2](foto/6.1.png)

##### 2) в файле *resolv.conf* прописать `nameserver 8.8.8.8.`
![r2](foto/6.2.png)

##### Перезагрузить службу **DHCP** командой `systemctl restart isc-dhcp-server`. Машину ws21 перезагрузить при помощи `reboot` и через `ip a` показать, что она получила адрес. Также пропинговать ws22 с ws21.
* Перезагрузка службы **DHCP**
![ip a](foto/6.3.png)

* Вывод команды 'ip a' на ws21
![ip a](foto/6.4.png)

* Пинг с ws22 к ws21
![ip a](foto/6.5.png)

##### Указать MAC адрес у ws11, для этого в *etc/netplan/00-installer-config.yaml* надо добавить строки: `macaddress: 10:10:10:10:10:BA`, `dhcp4: true`
![mac](foto/6.6.png)

##### Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты
* /etc/dhcp/dhcpd.conf для машины r1
![r1](foto/6.7.png)

* r1 /etc/dhcp.conf
![r1](foto/6.8.png)

* Перезагрузка службы DHCP командой 'systemctl restart isc-dhcp-server'
![dhcp](foto/6.9.png)

* перезагрузка ws11  при помощи 'sudo reboot' , проверка адреса через 'ip a'
![ws11](foto/6.10.png)

##### Запросить с ws21 обновление ip адреса
* 'ip a' до 
![ip a](foto/6.11.png)

* 'ip a' после 
![ip a](foto/6.12.png)

* 'dhclient -r' для сброса текущего адреса
* 'dhclient -v'для получения нового адреса

## Part 7. **NAT**

**== Задание ==**
sudo apt install apache2
##### В файле */etc/apache2/ports.conf* на ws22 и r1 изменить строку `Listen 80` на `Listen 0.0.0.0:80`, то есть сделать сервер Apache2 общедоступным
* ws22
![ws22](foto/7.1.png)

* r1
![r1](foto/7.2.png)

##### Запустить веб-сервер Apache командой `service apache2 start` на ws22 и r1
* ws22
![ws22](foto/7.3.png)

* r1
![r1](foto/7.4.png)

##### Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:
##### 1) Удаление правил в таблице filter - `iptables -F`
##### 2) Удаление правил в таблице "NAT" - `iptables -F -t nat`
##### 3) Отбрасывать все маршрутизируемые пакеты - `iptables --policy FORWARD DROP`
![r2](foto/7.5.png)

##### Запустить файл
![chmod](foto/7.6.png)

##### Проверить соединение между ws22 и r1 командой `ping`
![ping](foto/7.7.png)
* Пинг не проходит

##### Добавить в файл ещё одно правило:
##### 4) Разрешить маршрутизацию всех пакетов протокола **ICMP**
##### Запускать файл также, как в Части 4
![r2](foto/7.8.png)
![chmod](foto/7.9.png)

##### Проверить соединение между ws22 и r1 командой `ping`
![ping](foto/7.10.png)
* Пинг проходит

##### Добавить в файл ещё два правила:
##### 5) Включить **SNAT**, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)
##### 6) Включить **DNAT** на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети
![r2](foto/7.11.png)
##### Запускать файл также, как в Части 4
![chmod](foto/7.12.png)

*Перед тестированием рекомендуется отключить сетевой интерфейс **NAT** (его наличие можно проверить командой `ip a`) в VirtualBox, если он включен*
##### Проверить соединение по TCP для **SNAT**, для этого с ws22 подключиться к серверу Apache на r1 командой:
`telnet [адрес] [порт]`
![telnet](foto/7.13.png)

##### Проверить соединение по TCP для **DNAT**, для этого с r1 подключиться к серверу Apache на ws22 командой `telnet` (обращаться по адресу r2 и порту 8080)
![telnet](foto/7.14.png)


## Part 8. Дополнительно. Знакомство с **SSH Tunnels**
##### Запустить на r2 фаервол с правилами из Части 7
![r2](foto/8.1.png)
![chmod](foto/8.2.png)
##### Запустить веб-сервер **Apache** на ws22 только на localhost (то есть в файле */etc/apache2/ports.conf* изменить строку `Listen 80` на `Listen localhost:80`)
![ws22](foto/8.3.png)

##### Воспользоваться *Local TCP forwarding* с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21
* 'ssh -L local_port:remote_ip:remote_port user@hostname'
![ssh -L](foto/8.4.png)
##### Воспользоваться *Remote TCP forwarding* c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11
* 'ssh -R remote_port:local_ip:local_port user@hostname'
![ssh -L](foto/8.5.png)

##### Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейдите во второй терминал (например, клавишами Alt + F2) и выполните команду:
`telnet 127.0.0.1 [локальный порт]`

![telnet](foto/8.6.png)

![telnet](foto/8.7.png)